<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Dropbox ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ€ãƒ¼</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
</head>
<body>
  <h2>å¦‚æœˆãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</h2>
  <input type="file" id="fileInput">
  <button id="uploadBtn">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  <p id="status"></p>
  <p id="usage"></p>
  <button id="refreshBtn">ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º</button>
  <ul id="fileList"></ul>

  <script>
    const ACCESS_TOKEN = 'youtoken'; // â† è‡ªåˆ†ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã«å·®ã—æ›¿ãˆã‚‹
    const MAX_TOTAL_BYTES = 500 * 1024 * 1024; // 500MBåˆ¶é™

    const dbx = new Dropbox.Dropbox({ accessToken: ACCESS_TOKEN });

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const fileList = document.getElementById('fileList');
    const status = document.getElementById('status');
    const usage = document.getElementById('usage');

    function formatSize(bytes) {
      if (bytes < 1024) return `${bytes} B`;
      if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
      return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    function updateStorageUsage() {
  dbx.usersGetSpaceUsage()
    .then(response => {
      const used = response.result.used;
      const maxLimit = MAX_TOTAL_BYTES; // â† 512MBï¼ˆ= 500Ã—1024Ã—1024ï¼‰
      const percent = ((used / maxLimit) * 100).toFixed(1);
      usage.textContent = `ğŸ“¦ ä½¿ç”¨æ¸ˆã¿: ${formatSize(used)} / ${formatSize(maxLimit)}ï¼ˆ${percent}%ï¼‰`;
      window.__used_storage = used;
    })
    .catch(err => {
      console.error('ä½¿ç”¨é‡å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      usage.textContent = 'âš ï¸ ä½¿ç”¨é‡å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      window.__used_storage = 0;
    });
}

    function refreshFileList() {
      fileList.innerHTML = '<li>èª­ã¿è¾¼ã¿ä¸­...</li>';
      dbx.filesListFolder({ path: '' })
        .then(response => {
          const entries = response.result.entries;
          fileList.innerHTML = '';
          if (entries.length === 0) {
            fileList.innerHTML = '<li>ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</li>';
            return;
          }
          entries.forEach(entry => {
            if (entry['.tag'] === 'file') {
              const li = document.createElement('li');
              li.textContent = `${entry.name} (${formatSize(entry.size)}) `;

              const dlBtn = document.createElement('button');
              dlBtn.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
              dlBtn.addEventListener('click', () => downloadFile(entry.path_lower));
              li.appendChild(dlBtn);

              const delBtn = document.createElement('button');
              delBtn.textContent = 'å‰Šé™¤';
              delBtn.addEventListener('click', () => deleteFile(entry.path_lower));
              li.appendChild(delBtn);

              const infoBtn = document.createElement('button');
              infoBtn.textContent = 'ğŸ” è©³ç´°';
              infoBtn.addEventListener('click', () => showFileDetails(entry));
              li.appendChild(infoBtn);

              fileList.appendChild(li);
            }
          });
        })
        .catch(err => {
          console.error('ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
          fileList.innerHTML = '<li>âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>';
        });
    }

    function downloadFile(path) {
      status.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';
      dbx.filesDownload({ path })
        .then(response => {
          const blob = response.result.fileBlob || response.result.fileBinary;
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = response.result.name;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          status.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ';
        })
        .catch(err => {
          console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
          status.textContent = 'âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—';
        });
    }

    function showFileDetails(file) {
  const name = file.name;
  const size = formatSize(file.size);
  const path = file.path_display;
  const id = file.id;
  const updated = new Date(file.server_modified).toLocaleString();

  const message = `
ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ åå‰ï¼š${name}
ğŸ“¦ ã‚µã‚¤ã‚ºï¼š${size}
ğŸ“ ãƒ‘ã‚¹ï¼š${path}
ğŸ•’ æ›´æ–°æ—¥æ™‚ï¼š${updated}
ğŸ†” IDï¼š${id}
`.trim();

  alert(message);
}

    function deleteFile(path) {
      if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      dbx.filesDeleteV2({ path })
        .then(() => {
          status.textContent = 'ğŸ—‘ï¸ å‰Šé™¤å®Œäº†';
          refreshFileList();
          updateStorageUsage();
        })
        .catch(err => {
          console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
          status.textContent = 'âŒ å‰Šé™¤å¤±æ•—';
        });
    }

    uploadBtn.addEventListener('click', () => {
      const files = fileInput.files;
      if (files.length === 0) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      const file = files[0];

      if ((window.__used_storage || 0) + file.size > MAX_TOTAL_BYTES) {
        status.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸å¯ï¼šåˆè¨ˆã‚µã‚¤ã‚ºãŒ500MBã‚’è¶…ãˆã¾ã™';
        return;
      }

      status.textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      const reader = new FileReader();
      reader.onload = function(e) {
        const contents = e.target.result;
        dbx.filesUpload({
          path: '/' + file.name,
          contents: contents,
          mode: 'overwrite'
        })
        .then(() => {
          status.textContent = `âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: ${file.name}`;
          fileInput.value = '';
          refreshFileList();
          updateStorageUsage();
        })
        .catch(err => {
          console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
          status.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—';
        });
      };
      reader.readAsArrayBuffer(file);
    });

    refreshBtn.addEventListener('click', () => {
      refreshFileList();
      updateStorageUsage();
    });

    // åˆæœŸèª­ã¿è¾¼ã¿
    refreshFileList();
    updateStorageUsage();
  </script>
</body>
</html>
